# Initialisierung ----------------------------------------------------------------

# rm(list = ls())
# set.seed(1)

library(tidyverse)
library(tidyr)
library(readxl)
library(dplyr)
library(ggplot2)
library(MASS)
library(shiny)
library(DT)
library(stringr)
library(plotly)

# Daten laden -------------------------------------------------------------------
all_data_finalized <- read_xlsx("00_tidy/all_data_finalized.xlsx")
vorgaenge_raw <- read_excel("vorgaenge_sap_raw.xlsx")


# BALKENDIAGRAMM ZEITEN F√úR WORKFLOWS
#Um wieder die Lead Times auf Vorgangs- und Arbeitsplatzebene sehen zu k√∂nnen, 
# m√ºssen die sap_vorgaenge cleanen und dann pro Vorgang u Arbeitsplatz wieder die LT
# ermitteln. Wir ermitteln au√üerdem die Liegezeiten als Differenz zwischen Enddatum
# Vorgang 1 und Startdatum Folgevorgang. Wir ermitteln LT/Unit!

vorgaenge_raw <- vorgaenge_raw %>%
    filter(Auftragsnummer %in% all_data_finalized$auftragsnummer)

vorgaenge_cleaned <- vorgaenge_raw %>%
    left_join(
        all_data_finalized %>%
            dplyr::select(
                auftragsnummer,
                materialnummer,
                werk,
                starttermin_soll,
                endtermin_soll,
                fertigungslinie,
                planer,
                vorgangsfolge,
                arbeitsplatzfolge
            ),
        by = c("Auftragsnummer" = "auftragsnummer")
    )

vorgaenge_cleaned <- vorgaenge_cleaned %>%
    dplyr::select(-`ME`, -`Gutmenge Vorgang`, -`Ausschuss Vorgang`)

vorgaenge_cleaned <- vorgaenge_cleaned %>%
    mutate(
        `Iststart Vorgang` = as.Date(`Iststart Vorgang`),
        `Istende Vorgang`  = as.Date(`Istende Vorgang`)
    )

vorgaenge_cleaned <- vorgaenge_cleaned %>%
    mutate(
        solldauer = as.numeric(difftime(endtermin_soll, starttermin_soll, units = "days")),
        istdauer = as.numeric(difftime(`Istende Vorgang`, `Iststart Vorgang`, units = "days")),
        abweichung = istdauer - solldauer
    )
    

vorgaenge_cleaned <- vorgaenge_cleaned %>%
    arrange(vorgangsfolge, Vorgangsnummer)
    
vorgaenge_cleaned <- vorgaenge_cleaned %>%
    mutate(gesamtdauer = as.numeric(`Istende Vorgang` - `Iststart Vorgang`))

vorgaenge_sollzeiten <- vorgaenge_cleaned %>%
    mutate(solldauer = as.numeric(difftime(endtermin_soll, starttermin_soll, units = "days"))) %>%
    filter(!is.na(solldauer))

# 2. Berechne den Median der Soll-Dauer pro Workflow und Vorgang
solldauer_median <- vorgaenge_sollzeiten %>%
    group_by(vorgangsfolge, Vorgangsnummer) %>%
    summarise(solldauer_median = median(solldauer, na.rm = TRUE), .groups = "drop")



vorgaenge_sorted <- vorgaenge_cleaned %>%
    arrange(Auftragsnummer, `Iststart Vorgang`)

liegezeiten_plot <- vorgaenge_sorted %>%
    group_by(Auftragsnummer) %>%
    arrange(`Iststart Vorgang`) %>%
    mutate(
        vorheriges_ende = lag(`Istende Vorgang`),
        aktuelles_start = `Iststart Vorgang`
    ) %>%
    filter(!is.na(vorheriges_ende) & aktuelles_start > vorheriges_ende) %>%
    mutate(
        Typ = "Liegezeit",
        Start = vorheriges_ende,
        Ende = aktuelles_start
    ) %>%
    dplyr::select(Auftragsnummer, Typ, Start, Ende)



vorgaenge_plot <- vorgaenge_sorted %>%
    dplyr::select(
        Auftragsnummer,
        Vorgangsnummer,
        Typ = Vorgangsnummer,
        Start = `Iststart Vorgang`,
        Ende = `Istende Vorgang`
    )

workflow_plot_data <- bind_rows(vorgaenge_plot, liegezeiten_plot) %>%
    arrange(Auftragsnummer, Start) %>%
    group_by(Auftragsnummer) %>%
    mutate(Schritt = row_number()) %>%
    ungroup()


liegezeiten_df <- vorgaenge_sorted %>%
    group_by(Auftragsnummer) %>%
    mutate(
        vorheriges_ende = lag(`Istende Vorgang`),
        aktuelles_start = `Iststart Vorgang`,
        liegedauer = as.numeric(aktuelles_start - vorheriges_ende)
    ) %>%
    filter(!is.na(liegedauer) & liegedauer > 0) %>%  # Nur echte Liegezeiten
    summarise(
        Liegezeit_start = min(vorheriges_ende, na.rm = TRUE),
        Liegezeit_ende   = max(aktuelles_start, na.rm = TRUE),
        Liegedauer_gesamt = sum(liegedauer, na.rm = TRUE),
        .groups = "drop"
    )

# Alle Auftr√§ge mit Vorgangsdauern (auch ohne Liegezeiten)
auftrags_dauer <- vorgaenge_sorted %>%
    dplyr::select(Auftragsnummer, Vorgangsnummer, istdauer) %>%
    pivot_wider(
        names_from = Vorgangsnummer,
        values_from = istdauer
    )

auftrags_dauer <- vorgaenge_sorted %>%
    dplyr::select(Auftragsnummer, Vorgangsnummer, istdauer) %>%
    pivot_wider(names_from = Vorgangsnummer, values_from = istdauer)


# 2. Kombinieren mit Liegezeiten (auch wenn keine vorhanden)
liegezeit_u_auftragszeit <- auftrags_dauer %>%
    left_join(liegezeiten_df, by = "Auftragsnummer")


# Zusammenfassen der Auftr√§gen nach Vorgangsnummern um die Daten den einzelnen
# Workflows zuordnen zu k√∂nnen. Hier nutzen wir Median Werte f√ºr Liegezeit und
# Bearbeitungszeit

liegezeiten_df_erweitert <- liegezeit_u_auftragszeit %>%
    left_join(
        vorgaenge_cleaned %>% dplyr::select(Auftragsnummer, vorgangsfolge) %>% distinct(),
        by = "Auftragsnummer"
    )


vorgaenge_lz_bz <- liegezeiten_df_erweitert %>%
    group_by(vorgangsfolge) %>%
    summarise(across(
        .cols = c(Liegedauer_gesamt, `0010`, `0020`, `0030`, `0040`, `0050`, `0060`, `0070`, `0005`, `0032`),
        .fns = ~ median(.x, na.rm = TRUE),
        .names = "{.col}_median"
    )) 



df <- vorgaenge_lz_bz

# Funktion zur Umwandlung einer Zeile in langes Format
transform_row_to_long <- function(row) {
    row <- as_tibble(row)  # üîß Liste zu Tibble umwandeln
    id <- row$vorgangsfolge
    row_long <- row %>%
        dplyr::select(ends_with("_median")) %>%
        pivot_longer(
            cols = everything(),
            names_to = "Step",
            values_to = "Time"
        ) %>%
        filter(!is.na(Time)) %>%
        mutate(
            Step = str_replace(Step, "_median", ""),
            vorgangsfolge = id
        )
    return(row_long)
}
plot_workflow_structure <- function(df) {
    if (nrow(df) == 0) return(NULL)
    
    df_long <- df %>%
        pivot_longer(
            cols = ends_with("_median"),
            names_to = "Step",
            values_to = "Time"
        ) %>%
        filter(!is.na(Time)) %>%
        mutate(
            Step = str_replace(Step, "_median", ""),
            Step = ifelse(Step == "Liegedauer_gesamt", "Avg. Delay", Step),
            text_color = ifelse(Step == "Avg. Delay", "black", "white")
        ) %>%
        group_by(vorgangsfolge) %>%
        mutate(
            Total = sum(Time),
            pct = Time / Total,
            label = paste0(
                Step, "<br>",
                ifelse(Step == "Avg. Delay", "Avg. Delay [d]: ", "Avg. LT [d]: "),
                round(Time, 1), "<br>", round(pct * 100, 1), "%"
            ),
            xmin = cumsum(lag(pct, default = 0)),
            xmax = cumsum(pct)
        ) %>%
        ungroup()
    
    color_map <- c(
        "0010" = "#c6dbef", "0020" = "#9ecae1", "0030" = "#6baed6",
        "0040" = "#4292c6", "0050" = "#2171b5", "0060" = "#08519c",
        "0070" = "#08306b", "0005" = "#b3cde3", "0032" = "#a6bddb",
        "Avg. Delay" = "#f5f7fa"
    )
    
    p <- ggplot(df_long) +
        geom_rect(
            aes(xmin = xmin, xmax = xmax, ymin = 0, ymax = 1, fill = Step, text = label),
            color = NA
        ) +
        geom_text(
            data = df_long %>% filter(pct > 0.05),
            aes(x = (xmin + xmax) / 2, y = 0.5, label = Step, color = text_color),
            size = 3.5,
            show.legend = FALSE
        ) +
        scale_fill_manual(values = color_map) +
        scale_color_identity() +
        facet_wrap(~ vorgangsfolge, ncol = 1, scales = "free") +
        theme_void() +
        theme(
            legend.position = "bottom",
            strip.text = element_text(hjust = 0.5, face = "bold")
        )
    
    ggplotly(p, tooltip = "text")
}

# H√§ufigkeitsverteilung der Abweichungen f√ºr jeden Workflow

plot_abweichung_histogram <- function(df, selected_workflow) {
    df_filtered <- df %>%
        filter(vorgangsfolge == selected_workflow & !is.na(abweichung))
    
    if (nrow(df_filtered) == 0) return(NULL)
    
    # Dynamische Grenzen anhand 1% und 99% Quantil
    x_min <- quantile(df_filtered$abweichung, 0.025)
    x_max <- quantile(df_filtered$abweichung, 0.975)
    
    p <- ggplot(df_filtered, aes(x = abweichung)) +
        geom_histogram(binwidth = 1, fill = "#4B9CD3", color = "white", boundary = 0) +
        labs(
            title = paste("Verteilung der Abweichungen ‚Äì Workflow", selected_workflow),
            x = "Abweichung (Ist - Soll) [Tage]",
            y = "H√§ufigkeit"
        ) +
        scale_x_continuous(limits = c(x_min, x_max)) +
        theme_minimal(base_family = "Inter") +
        theme(
            plot.title = element_text(size = 14, face = "bold"),
            axis.title = element_text(size = 12),
            axis.text = element_text(size = 11)
        )
    
    ggplotly(p)
}

plot_ist_vs_soll_comparison <- function(vorgaenge_df, selected_workflow) {
    # Filter auf gew√§hlten Workflow
    df_filtered <- vorgaenge_df %>%
        filter(vorgangsfolge == selected_workflow) %>%
        mutate(soll_dauer = as.numeric(difftime(endtermin_soll, starttermin_soll, units = "days")),
               ist_dauer  = as.numeric(difftime(`Istende Vorgang`, `Iststart Vorgang`, units = "days"))) %>%
        filter(!is.na(soll_dauer) & !is.na(ist_dauer))
    
    if (nrow(df_filtered) == 0) return(NULL)
    
    # Berechne Median pro Vorgangsnummer
    df_summary <- df_filtered %>%
        group_by(Vorgangsnummer) %>%
        summarise(
            Soll = median(soll_dauer, na.rm = TRUE),
            Ist  = median(ist_dauer, na.rm = TRUE),
            .groups = "drop"
        ) %>%
        pivot_longer(cols = c("Soll", "Ist"), names_to = "Typ", values_to = "Dauer")
    
    # Balkendiagramm
    p <- ggplot(df_summary, aes(x = Vorgangsnummer, y = Dauer, fill = Typ)) +
        geom_col(data = subset(df_summary, Typ == "Soll"),
                 position = position_identity(),
                 width = 0.6,
                 fill = "lightgrey") +
        geom_col(data = subset(df_summary, Typ == "Ist"),
                 position = position_identity(),
                 width = 0.4,
                 fill = "#1f77b4") +
        labs(
            title = paste("Soll-Ist Vergleich ‚Äì Workflow", selected_workflow),
            x = "Vorgang",
            y = "Median Dauer [Tage]"
        ) +
        theme_minimal(base_family = "Inter") +
        theme(
            plot.title = element_text(size = 14, face = "bold"),
            axis.title = element_text(size = 12),
            axis.text = element_text(size = 11),
            legend.position = "none"
        )
    
    ggplotly(p)
}